<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pachinko RPG Idle Game</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; margin: 20px; background: #f4f4f4; }
        button { font-size: 16px; padding: 10px; margin: 10px; background: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        canvas { background: #333; display: block; margin: auto; border: 5px solid #555; border-radius: 10px; }
        .minigame { display: none; margin-top: 20px; }
        .prestige-menu { display: none; margin-top: 20px; }
        h1 { color: #333; }
        p { font-size: 18px; color: #555; }
    </style>
</head>
<body>
    <h1>Pachinko RPG Idle Game</h1>
    <p>Gold: <span id="gold">0</span></p>
    <p>Average Gold/s: <span id="goldPerSecond">0</span></p>
    <button onclick="dropBall()">Drop Hero</button>
    <button id="ballValueUpgradeButton" onclick="upgradeBallValue()">Upgrade Ball Value (Cost: <span id="ballUpgradeCost">25</span> gold)</button>
    <button id="autoDropUpgradeButton" onclick="upgradeAutoDrop()">Upgrade Auto Drop (Cost: <span id="autoDropUpgradeCost">50</span> gold)</button>
    <button id="pegBonusUpgradeButton" onclick="upgradePegBonus()" style="display: none;">Upgrade Peg Bonus (Cost: <span id="pegUpgradeCost">75</span> gold)</button>
    <button id="ballLimitUpgradeButton" onclick="upgradeBallLimit()" style="display: none;">Upgrade Ball Limit (Cost: <span id="limitUpgradeCost">50</span> gold)</button>
    <button id="boardSizeUpgradeButton" onclick="upgradeBoardSize()" style="display: none;">Upgrade Board Size (Cost: <span id="boardUpgradeCost">100</span> gold)</button>
    <button id="prestigeButton" onclick="prestige()" style="display: none;">Prestige (Gain <span id="prestigeBonus">0</span> Prestige Points)</button>
    <button onclick="startMinigame()">Play Mini-Game</button>
    <div class="prestige-menu">
        <h2>Prestige Upgrades</h2>
        <button onclick="buyGoldenBallUpgrade()">Golden Ball Chance (Cost: <span id="goldenBallUpgradeCost">1</span> PP)</button>
        <button onclick="toggleBucketMultiplier()">Toggle Bucket Multipliers (Cost: <span id="bucketMultiplierUpgradeCost">2</span> PP)</button>
        <button onclick="buyMagnetUpgrade()">Magnet Upgrade (Cost: <span id="magnetUpgradeCost">3</span> PP)</button>
    </div>
    <canvas id="pachinkoCanvas" width="400" height="400"></canvas>
    <div class="minigame">
        <h2>Mini-Game: Catch the Silly Faces!</h2>
        <canvas id="minigameCanvas" width="400" height="400"></canvas>
    </div>

    <script>
        let gold = 0;
        let ballValue = 1;
        let pegBonus = 1;
        let ballLimit = 3;
        let autoDropInterval = 1000;
        let autoDropLevel = 0;
        let prestigePoints = 0;
        let globalMultiplier = 1;
        let ballUpgradeCost = 25;
        let pegUpgradeCost = 75;
        let limitUpgradeCost = 50;
        let boardUpgradeCost = 100;
        let autoDropUpgradeCost = 50;
        let goldenBallChance = 0; // Chance to spawn a golden ball
        let goldenBallUpgradeCost = 1;
        let bucketMultiplierUpgradeCost = 2;
        let magnetUpgradeCost = 3;
        let bucketMultiplierToggled = false;
        let magnetActive = false; // Magnet upgrade to attract balls to higher-value buckets
        let balls = [];
        let pegs = [];
        let canvasWidth = 400;
        let canvasHeight = 400;
        let buckets = [];
        let goldPerSecond = 0;
        let goldHistory = [];
        let minigameActive = false;

        const canvas = document.getElementById("pachinkoCanvas");
        const ctx = canvas.getContext("2d");
        const minigameCanvas = document.getElementById("minigameCanvas");
        const minigameCtx = minigameCanvas.getContext("2d");

        function createBuckets() {
            const bucketMultipliers = [2, 1, 0.5, 5, 0, 5, 0.5, 1, 2];
            const totalWidth = canvasWidth;
            const bucketWidth = totalWidth / bucketMultipliers.length;
            buckets = bucketMultipliers.map((multiplier, index) => ({
                x: index * bucketWidth,
                width: multiplier === 5 || multiplier === 2 || multiplier === 0 ? bucketWidth * 0.8 : bucketWidth, // Smaller buckets for 5x, 2x, and 0x
                multiplier: multiplier,
                color: multiplier === 5 ? "gold" : multiplier === 2 ? "lightgreen" : multiplier === 1 ? "lightblue" : multiplier === 0 ? "gray" : "lightcoral"
            }));
        }

        class Ball {
            constructor(x) {
                this.x = x;
                this.y = 0;
                this.vx = (Math.random() - 0.5) * 2;
                this.vy = 0;
                this.radius = 10;
                this.value = ballValue;
                this.isGolden = Math.random() < goldenBallChance; // Chance to be a golden ball
                this.hitPegs = [];
                this.combo = 1; // Combo multiplier for pegs
            }
            update() {
                this.vy += 0.1; // Increased gravity
                this.y += this.vy;
                this.x += this.vx;

                // Magnet effect: attract balls toward higher-value buckets
                if (magnetActive) {
                    let targetBucket = buckets.reduce((a, b) => a.multiplier > b.multiplier ? a : b);
                    let dx = (targetBucket.x + targetBucket.width / 2) - this.x;
                    this.vx += dx * 0.01; // Gentle attraction
                }

                // Ball hitting walls
                if (this.x - this.radius < 0 || this.x + this.radius > canvasWidth) {
                    this.vx = -this.vx * 0.5;
                }

                // Ball hitting bucket borders
                for (let bucket of buckets) {
                    if (this.y + this.radius > canvasHeight - 50 && this.x > bucket.x && this.x < bucket.x + bucket.width) {
                        // Funnel ball into the bucket
                        let bucketCenter = bucket.x + bucket.width / 2;
                        this.vx += (bucketCenter - this.x) * 0.05;
                    }
                }

                // Ball hitting pegs
                for (let peg of pegs) {
                    let dx = peg.x - this.x;
                    let dy = peg.y - this.y;
                    let dist = Math.sqrt(dx * dx + dy * dy);
                    if (dist < this.radius + peg.radius && !this.hitPegs.includes(peg)) {
                        this.vy = -this.vy * 0.5;
                        this.vx += (Math.random() - 0.5) * 1;
                        this.value += Math.floor(pegBonus * this.combo); // Combo increases peg bonus (integer)
                        this.combo += 0.1; // Increase combo for each peg hit
                        this.hitPegs.push(peg);
                    }
                }

                // Ball falls into a bucket
                if (this.y > canvasHeight) {
                    let bucket = buckets.find(b => this.x > b.x && this.x < b.x + b.width);
                    if (bucket) {
                        let multiplier = bucket.multiplier;
                        if (bucketMultiplierToggled) {
                            if (multiplier === 2 || multiplier === 5) multiplier *= 2;
                            if (multiplier === 0.5) multiplier /= 2;
                        }
                        gold += Math.floor(this.value * multiplier * globalMultiplier * (this.isGolden ? 5 : 1)); // Golden balls are worth 5x (integer)
                    }
                    balls.splice(balls.indexOf(this), 1);
                    updateUI();
                }
            }
            draw() {
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
                ctx.fillStyle = this.isGolden ? "gold" : "blue";
                ctx.fill();
                ctx.closePath();
                ctx.fillStyle = "white";
                ctx.font = "12px Arial";
                ctx.textAlign = "center";
                ctx.fillText(Math.floor(this.value), this.x, this.y + 4); // Centered text (integer)
            }
        }

        class Peg {
            constructor(x, y) {
                this.x = x;
                this.y = y;
                this.radius = 5;
            }
            draw() {
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
                ctx.fillStyle = "red";
                ctx.fill();
                ctx.closePath();
            }
        }

        function drawBuckets() {
            buckets.forEach(bucket => {
                ctx.fillStyle = bucket.color;
                ctx.fillRect(bucket.x, canvasHeight - 50, bucket.width, 50);
                ctx.strokeStyle = "black";
                ctx.lineWidth = 2;
                ctx.strokeRect(bucket.x, canvasHeight - 50, bucket.width, 50); // Draw bucket borders
                ctx.fillStyle = "black";
                ctx.font = "16px Arial";
                ctx.textAlign = "center";
                ctx.fillText(bucket.multiplier + "x", bucket.x + bucket.width / 2, canvasHeight - 20); // Draw multiplier text
            });
        }

        function dropBall() {
            if (balls.length < ballLimit) {
                balls.push(new Ball(Math.random() * canvasWidth));
            }
        }

        function upgradeBallValue() {
            if (gold >= ballUpgradeCost) {
                gold -= ballUpgradeCost;
                ballValue++;
                ballUpgradeCost = Math.floor(ballUpgradeCost * 1.2);
                updateUI();
            }
        }

        function upgradeAutoDrop() {
            if (gold >= autoDropUpgradeCost) {
                gold -= autoDropUpgradeCost;
                autoDropInterval = Math.max(100, autoDropInterval * 0.9);
                autoDropLevel++;
                autoDropUpgradeCost = Math.floor(autoDropUpgradeCost * 1.2);
                updateUI();
            }
        }

        function upgradePegBonus() {
            if (gold >= pegUpgradeCost) {
                gold -= pegUpgradeCost;
                pegBonus++;
                pegUpgradeCost = Math.floor(pegUpgradeCost * 1.2);
                updateUI();
            }
        }

        function upgradeBallLimit() {
            if (gold >= limitUpgradeCost) {
                gold -= limitUpgradeCost;
                ballLimit++;
                limitUpgradeCost = Math.floor(limitUpgradeCost * 1.2);
                updateUI();
            }
        }

        function upgradeBoardSize() {
            if (gold >= boardUpgradeCost) {
                gold -= boardUpgradeCost;
                canvasWidth += 100;
                canvasHeight += 100;
                canvas.width = canvasWidth;
                canvas.height = canvasHeight;
                boardUpgradeCost = Math.floor(boardUpgradeCost * 1.5);
                createPegs();
                createBuckets();
                updateUI();
            }
        }

        function prestige() {
            if (gold >= 1000) {
                prestigePoints += Math.floor(gold / 1000);
                gold = 0;
                ballValue = 1;
                pegBonus = 1;
                ballLimit = 3;
                autoDropInterval = 1000;
                autoDropLevel = 0;
                ballUpgradeCost = 25;
                pegUpgradeCost = 75;
                limitUpgradeCost = 50;
                boardUpgradeCost = 100;
                autoDropUpgradeCost = 50;
                canvasWidth = 400;
                canvasHeight = 400;
                canvas.width = canvasWidth;
                canvas.height = canvasHeight;
                createPegs();
                createBuckets();
                globalMultiplier += prestigePoints * 0.1;
                document.querySelector(".prestige-menu").style.display = "block";
                updateUI();
            }
        }

        function buyGoldenBallUpgrade() {
            if (prestigePoints >= goldenBallUpgradeCost) {
                prestigePoints -= goldenBallUpgradeCost;
                goldenBallChance += 0.01; // Increase chance by 1%
                goldenBallUpgradeCost += 1;
                updateUI();
            }
        }

        function toggleBucketMultiplier() {
            if (prestigePoints >= bucketMultiplierUpgradeCost) {
                prestigePoints -= bucketMultiplierUpgradeCost;
                bucketMultiplierToggled = !bucketMultiplierToggled;
                updateUI();
            }
        }

        function buyMagnetUpgrade() {
            if (prestigePoints >= magnetUpgradeCost) {
                prestigePoints -= magnetUpgradeCost;
                magnetActive = true;
                updateUI();
            }
        }

        function updateUI() {
            document.getElementById("gold").innerText = Math.floor(gold);
            document.getElementById("ballUpgradeCost").innerText = Math.floor(ballUpgradeCost);
            document.getElementById("autoDropUpgradeCost").innerText = Math.floor(autoDropUpgradeCost);
            document.getElementById("pegUpgradeCost").innerText = Math.floor(pegUpgradeCost);
            document.getElementById("limitUpgradeCost").innerText = Math.floor(limitUpgradeCost);
            document.getElementById("boardUpgradeCost").innerText = Math.floor(boardUpgradeCost);
            document.getElementById("prestigeBonus").innerText = Math.floor(prestigePoints + (gold / 1000)); // Show accurate Prestige Points
            document.getElementById("goldenBallUpgradeCost").innerText = Math.floor(goldenBallUpgradeCost);
            document.getElementById("bucketMultiplierUpgradeCost").innerText = Math.floor(bucketMultiplierUpgradeCost);
            document.getElementById("magnetUpgradeCost").innerText = Math.floor(magnetUpgradeCost);

            if (autoDropLevel >= 1) document.getElementById("pegBonusUpgradeButton").style.display = "inline";
            if (autoDropLevel >= 2) document.getElementById("ballLimitUpgradeButton").style.display = "inline";
            if (autoDropLevel >= 3) document.getElementById("boardSizeUpgradeButton").style.display = "inline";
            if (gold >= 1000) document.getElementById("prestigeButton").style.display = "inline";
        }

        function gameLoop() {
            ctx.clearRect(0, 0, canvasWidth, canvasHeight);
            drawBuckets();
            balls.forEach(ball => { ball.update(); ball.draw(); });
            pegs.forEach(peg => peg.draw());
            requestAnimationFrame(gameLoop);
        }

        function createPegs() {
            pegs = [];
            let offset = 25;
            for (let i = 50; i < canvasHeight - 100; i += 50) {
                for (let j = offset; j < canvasWidth - 50; j += 50) {
                    if (j > 50 && j < canvasWidth - 50) {
                        pegs.push(new Peg(j, i));
                    }
                }
                offset = offset === 25 ? 0 : 25;
            }
        }

        function autoDrop() {
            if (balls.length < ballLimit) {
                dropBall();
            }
            setTimeout(autoDrop, autoDropInterval);
        }

        function calculateGoldPerSecond() {
            if (goldHistory.length >= 10) goldHistory.shift();
            goldHistory.push(gold);
            if (goldHistory.length > 1) {
                goldPerSecond = (goldHistory[goldHistory.length - 1] - goldHistory[0]) / goldHistory.length;
            }
            document.getElementById("goldPerSecond").innerText = Math.floor(goldPerSecond);
            setTimeout(calculateGoldPerSecond, 1000);
        }

        function startMinigame() {
            minigameActive = true;
            document.querySelector(".minigame").style.display = "block";
            minigameLoop();
        }

        let minigameObjects = [];
        class MinigameObject {
            constructor() {
                this.x = Math.random() * 400;
                this.y = 0;
                this.radius = 20;
                this.speed = 2 + Math.random() * 3;
                this.face = ["😀", "😎", "🤪", "👻", "🐱", "🦄"][Math.floor(Math.random() * 6)]; // Silly faces
            }
            update() {
                this.y += this.speed;
                if (this.y > 400) {
                    minigameObjects.splice(minigameObjects.indexOf(this), 1);
                }
            }
            draw() {
                minigameCtx.font = "24px Arial";
                minigameCtx.textAlign = "center";
                minigameCtx.fillText(this.face, this.x, this.y); // Draw silly face
            }
        }

        function minigameLoop() {
            if (!minigameActive) return;
            minigameCtx.clearRect(0, 0, 400, 400);
            if (Math.random() < 0.05) minigameObjects.push(new MinigameObject());
            minigameObjects.forEach(obj => { obj.update(); obj.draw(); });
            requestAnimationFrame(minigameLoop);
        }

        minigameCanvas.addEventListener("click", (e) => {
            if (!minigameActive) return;
            let rect = minigameCanvas.getBoundingClientRect();
            let x = e.clientX - rect.left;
            let y = e.clientY - rect.top;
            minigameObjects.forEach((obj, index) => {
                let dx = obj.x - x;
                let dy = obj.y - y;
                if (Math.sqrt(dx * dx + dy * dy) < obj.radius) {
                    gold += 50 * globalMultiplier; // Reward for clicking objects
                    minigameObjects.splice(index, 1);
                }
            });
        });

        createBuckets();
        createPegs();
        gameLoop();
        autoDrop();
        calculateGoldPerSecond();
    </script>
</body>
</html>
    </script>
</body>
</html>
